# =============================================================================
# CPK/SPC Calculator - Alertmanager Configuration
# =============================================================================
# File: monitoring/alertmanager.yml
# MÃ´ táº£: Cáº¥u hÃ¬nh Alertmanager cho gá»­i cáº£nh bÃ¡o qua Slack vÃ  Email
#
# HÆ°á»›ng dáº«n:
# 1. Thay tháº¿ cÃ¡c giÃ¡ trá»‹ placeholder (YOUR_*) báº±ng giÃ¡ trá»‹ thá»±c táº¿
# 2. Copy file nÃ y vÃ o thÆ° má»¥c config cá»§a Alertmanager
# 3. Restart Alertmanager: systemctl restart alertmanager
# =============================================================================

global:
  # Thá»i gian chá» trÆ°á»›c khi Ä‘Ã¡nh dáº¥u alert Ä‘Ã£ resolved
  resolve_timeout: 5m

  # ===== SMTP Configuration (Email) =====
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'YOUR_EMAIL@gmail.com'
  smtp_auth_username: 'YOUR_EMAIL@gmail.com'
  smtp_auth_password: 'YOUR_APP_PASSWORD'
  smtp_require_tls: true

  # ===== Slack Configuration =====
  slack_api_url: 'https://hooks.slack.com/services/YOUR_SLACK_WEBHOOK_URL'

# =============================================================================
# Templates
# =============================================================================
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# =============================================================================
# Route Tree - Äiá»u hÆ°á»›ng alerts Ä‘áº¿n receivers phÃ¹ há»£p
# =============================================================================
route:
  # Receiver máº·c Ä‘á»‹nh
  receiver: 'slack-critical'

  # NhÃ³m alerts theo labels
  group_by: ['alertname', 'service', 'component']

  # Thá»i gian chá» trÆ°á»›c khi gá»­i notification Ä‘áº§u tiÃªn
  group_wait: 30s

  # Thá»i gian chá» giá»¯a cÃ¡c notification cho cÃ¹ng group
  group_interval: 5m

  # Thá»i gian chá» trÆ°á»›c khi gá»­i láº¡i notification cho alert Ä‘Ã£ gá»­i
  repeat_interval: 4h

  # Routes con - Æ°u tiÃªn tá»« trÃªn xuá»‘ng
  routes:
    # Critical alerts â†’ Slack + Email
    - match:
        severity: critical
      receiver: 'slack-and-email-critical'
      group_wait: 10s
      repeat_interval: 1h
      continue: false

    # Warning alerts â†’ Slack only
    - match:
        severity: warning
      receiver: 'slack-warning'
      group_wait: 1m
      repeat_interval: 4h
      continue: false

    # Info alerts â†’ Slack info channel
    - match:
        severity: info
      receiver: 'slack-info'
      group_wait: 5m
      repeat_interval: 12h
      continue: false

    # Database-specific alerts â†’ dedicated channel
    - match:
        component: database
      receiver: 'slack-database'
      group_wait: 15s
      repeat_interval: 2h
      continue: false

# =============================================================================
# Inhibition Rules - NgÄƒn cháº·n alerts trÃ¹ng láº·p
# =============================================================================
inhibit_rules:
  # Náº¿u application down, khÃ´ng cáº§n gá»­i alert cho tá»«ng service
  - source_match:
      alertname: 'ApplicationDown'
    target_match_re:
      alertname: 'DatabaseConnectionLost|WebSocketUnavailable|RedisDisconnected'
    equal: ['service']

  # Náº¿u critical, suppress warning cho cÃ¹ng component
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname', 'service', 'component']

  # Database critical suppress database warning
  - source_match:
      alertname: 'DatabaseLatencyCritical'
    target_match:
      alertname: 'DatabaseLatencyHigh'
    equal: ['service']

  # Memory critical suppress memory warning
  - source_match:
      alertname: 'SystemMemoryHigh'
    target_match:
      alertname: 'SystemMemoryWarning'
    equal: ['service']

  # CPU critical suppress CPU warning
  - source_match:
      alertname: 'CPULoadCritical'
    target_match:
      alertname: 'CPULoadHigh'
    equal: ['service']

# =============================================================================
# Receivers - KÃªnh nháº­n cáº£nh bÃ¡o
# =============================================================================
receivers:
  # ===== Slack Critical (+ Email) =====
  - name: 'slack-and-email-critical'
    slack_configs:
      - channel: '#spc-alerts-critical'
        send_resolved: true
        username: 'CPK/SPC Alert Bot'
        icon_emoji: ':rotating_light:'
        color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'
        title: '{{ if eq .Status "firing" }}ðŸš¨ CRITICAL{{ else }}âœ… RESOLVED{{ end }} | {{ .CommonLabels.alertname }}'
        text: >-
          *Service:* {{ .CommonLabels.service }}
          *Component:* {{ .CommonLabels.component }}
          *Severity:* {{ .CommonLabels.severity }}
          *Status:* {{ .Status | toUpper }}

          {{ range .Alerts }}
          *Alert:* {{ .Labels.alertname }}
          *Description:* {{ .Annotations.description }}
          *Started:* {{ .StartsAt.Format "2006-01-02 15:04:05 MST" }}
          {{ if .EndsAt }}*Ended:* {{ .EndsAt.Format "2006-01-02 15:04:05 MST" }}{{ end }}
          {{ if .Annotations.runbook_url }}*Runbook:* {{ .Annotations.runbook_url }}{{ end }}
          {{ if .Annotations.dashboard_url }}*Dashboard:* {{ .Annotations.dashboard_url }}{{ end }}
          ---
          {{ end }}
        actions:
          - type: button
            text: 'View Dashboard'
            url: 'https://grafana.example.com/d/cpk-spc-monitoring'
          - type: button
            text: 'Health Check'
            url: 'https://your-app.example.com/api/health/detailed'
    email_configs:
      - to: 'admin@example.com, ops-team@example.com'
        send_resolved: true
        headers:
          Subject: '{{ if eq .Status "firing" }}ðŸš¨ CRITICAL{{ else }}âœ… RESOLVED{{ end }} CPK/SPC: {{ .CommonLabels.alertname }}'
        html: |
          <h2 style="color: {{ if eq .Status "firing" }}#dc3545{{ else }}#28a745{{ end }};">
            {{ if eq .Status "firing" }}ðŸš¨ CRITICAL ALERT{{ else }}âœ… RESOLVED{{ end }}
          </h2>
          <table style="border-collapse: collapse; width: 100%;">
            <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>Service</strong></td><td style="padding: 8px; border: 1px solid #ddd;">{{ .CommonLabels.service }}</td></tr>
            <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>Component</strong></td><td style="padding: 8px; border: 1px solid #ddd;">{{ .CommonLabels.component }}</td></tr>
            <tr><td style="padding: 8px; border: 1px solid #ddd;"><strong>Severity</strong></td><td style="padding: 8px; border: 1px solid #ddd;">{{ .CommonLabels.severity }}</td></tr>
          </table>
          {{ range .Alerts }}
          <h3>{{ .Labels.alertname }}</h3>
          <p>{{ .Annotations.description }}</p>
          <p><strong>Started:</strong> {{ .StartsAt.Format "2006-01-02 15:04:05 MST" }}</p>
          {{ end }}
          <p><a href="https://grafana.example.com/d/cpk-spc-monitoring">View Dashboard</a></p>

  # ===== Slack Critical (without Email) =====
  - name: 'slack-critical'
    slack_configs:
      - channel: '#spc-alerts-critical'
        send_resolved: true
        username: 'CPK/SPC Alert Bot'
        icon_emoji: ':rotating_light:'
        color: '{{ if eq .Status "firing" }}danger{{ else }}good{{ end }}'
        title: '{{ if eq .Status "firing" }}ðŸš¨ CRITICAL{{ else }}âœ… RESOLVED{{ end }} | {{ .CommonLabels.alertname }}'
        text: >-
          *Service:* {{ .CommonLabels.service }}
          *Component:* {{ .CommonLabels.component }}
          {{ range .Alerts }}
          *Description:* {{ .Annotations.description }}
          {{ end }}

  # ===== Slack Warning =====
  - name: 'slack-warning'
    slack_configs:
      - channel: '#spc-alerts-warning'
        send_resolved: true
        username: 'CPK/SPC Alert Bot'
        icon_emoji: ':warning:'
        color: '{{ if eq .Status "firing" }}warning{{ else }}good{{ end }}'
        title: '{{ if eq .Status "firing" }}âš ï¸ WARNING{{ else }}âœ… RESOLVED{{ end }} | {{ .CommonLabels.alertname }}'
        text: >-
          *Service:* {{ .CommonLabels.service }}
          *Component:* {{ .CommonLabels.component }}
          {{ range .Alerts }}
          *Description:* {{ .Annotations.description }}
          {{ end }}

  # ===== Slack Info =====
  - name: 'slack-info'
    slack_configs:
      - channel: '#spc-alerts-info'
        send_resolved: false
        username: 'CPK/SPC Alert Bot'
        icon_emoji: ':information_source:'
        color: '#439FE0'
        title: 'â„¹ï¸ INFO | {{ .CommonLabels.alertname }}'
        text: >-
          {{ range .Alerts }}
          {{ .Annotations.description }}
          {{ end }}

  # ===== Slack Database =====
  - name: 'slack-database'
    slack_configs:
      - channel: '#spc-database-alerts'
        send_resolved: true
        username: 'CPK/SPC DB Monitor'
        icon_emoji: ':floppy_disk:'
        color: '{{ if eq .Status "firing" }}{{ if eq .CommonLabels.severity "critical" }}danger{{ else }}warning{{ end }}{{ else }}good{{ end }}'
        title: '{{ if eq .Status "firing" }}ðŸ—„ï¸ DB ALERT{{ else }}âœ… DB RESOLVED{{ end }} | {{ .CommonLabels.alertname }}'
        text: >-
          *Severity:* {{ .CommonLabels.severity }}
          {{ range .Alerts }}
          *Description:* {{ .Annotations.description }}
          *Started:* {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}
