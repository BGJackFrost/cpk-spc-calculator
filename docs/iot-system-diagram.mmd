%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#0ea5e9', 'primaryTextColor': '#fff', 'primaryBorderColor': '#0284c7', 'lineColor': '#64748b', 'secondaryColor': '#f0f9ff', 'tertiaryColor': '#e0f2fe'}}}%%
flowchart TB
    subgraph DataSources["ðŸ“¡ NGUá»’N Dá»® LIá»†U Gá»C"]
        direction TB
        PLC["ðŸ”§ PLC/Controller"]
        Sensors["ðŸŒ¡ï¸ Sensors"]
        Gateway["ðŸ“¶ Gateway"]
        HMI["ðŸ–¥ï¸ HMI/SCADA"]
        External["ðŸŒ External API"]
    end

    subgraph Protocols["ðŸ”Œ GIAO THá»¨C Káº¾T Ná»I"]
        direction TB
        MQTT["ðŸ“¨ MQTT Broker"]
        OPCUA["ðŸ”— OPC-UA Server"]
        Modbus["âš¡ Modbus TCP/RTU"]
        REST["ðŸŒ REST API"]
    end

    subgraph DataCollection["ðŸ“¥ THU THáº¬P Dá»® LIá»†U"]
        direction TB
        RealtimeBuffer["âš¡ Realtime Buffer"]
        DataPoints["ðŸ“Š Data Points"]
        DeviceData["ðŸ’¾ Device Data"]
    end

    subgraph DeviceManagement["ðŸ”§ QUáº¢N LÃ THIáº¾T Bá»Š"]
        direction TB
        DeviceCRUD["ðŸ“ Device CRUD"]
        DeviceGroups["ðŸ“ Device Groups"]
        DeviceTemplates["ðŸ“‹ Device Templates"]
        DeviceHealth["ðŸ’š Device Health"]
        DevicePositions["ðŸ“ Device Positions"]
    end

    subgraph Monitoring["ðŸ“Š GIÃM SÃT REALTIME"]
        direction TB
        RealtimeDashboard["ðŸ“ˆ Realtime Dashboard"]
        SensorDashboard["ðŸŒ¡ï¸ Sensor Dashboard"]
        FloorPlanView["ðŸ—ºï¸ Floor Plan View"]
        FloorPlan3D["ðŸ¢ 3D Floor Plan"]
        UnifiedDashboard["ðŸ“Š Unified Dashboard"]
    end

    subgraph AlertSystem["ðŸš¨ Há»† THá»NG Cáº¢NH BÃO"]
        direction TB
        AlarmCRUD["âš ï¸ Alarm CRUD"]
        Thresholds["ðŸ“ Thresholds Config"]
        AlertHistory["ðŸ“œ Alert History"]
        AlertEscalation["ðŸ“¢ Alert Escalation"]
        AlertCorrelation["ðŸ”— Alert Correlation"]
    end

    subgraph Notifications["ðŸ“¬ THÃ”NG BÃO"]
        direction TB
        Telegram["ðŸ’¬ Telegram"]
        Webhook["ðŸ”” Webhook"]
        SMS["ðŸ“± SMS"]
        Push["ðŸ“² Push Notification"]
        Email["ðŸ“§ Email"]
    end

    subgraph Maintenance["ðŸ”§ Báº¢O TRÃŒ"]
        direction TB
        WorkOrders["ðŸ“‹ Work Orders"]
        Technicians["ðŸ‘· Technicians"]
        Tasks["âœ… Tasks"]
        Schedules["ðŸ“… Maintenance Schedules"]
        PredictiveMaint["ðŸ”® Predictive Maintenance"]
    end

    subgraph Analytics["ðŸ“ˆ PHÃ‚N TÃCH"]
        direction TB
        MTTR_MTBF["ðŸ“Š MTTR/MTBF"]
        HealthAnalysis["ðŸ’š Health Analysis"]
        TrendAnalysis["ðŸ“ˆ Trend Analysis"]
        Predictions["ðŸ”® AI Predictions"]
        Reports["ðŸ“„ Reports Export"]
    end

    subgraph FirmwareOTA["ðŸ“¦ FIRMWARE & OTA"]
        direction TB
        FirmwarePackages["ðŸ“¦ Firmware Packages"]
        OTADeployments["ðŸš€ OTA Deployments"]
        ScheduledOTA["ðŸ“… Scheduled OTA"]
        DeviceStatus["ðŸ“Š Device Status"]
    end

    %% Data Flow from Sources to Protocols
    PLC --> MQTT
    PLC --> OPCUA
    PLC --> Modbus
    Sensors --> MQTT
    Sensors --> Modbus
    Gateway --> MQTT
    Gateway --> OPCUA
    HMI --> OPCUA
    External --> REST

    %% Protocols to Data Collection
    MQTT --> RealtimeBuffer
    OPCUA --> RealtimeBuffer
    Modbus --> RealtimeBuffer
    REST --> RealtimeBuffer
    RealtimeBuffer --> DataPoints
    RealtimeBuffer --> DeviceData

    %% Data Collection to Device Management
    DataPoints --> DeviceHealth
    DeviceData --> DeviceCRUD
    DeviceCRUD --> DeviceGroups
    DeviceCRUD --> DeviceTemplates
    DeviceCRUD --> DevicePositions

    %% Device Management to Monitoring
    DeviceCRUD --> RealtimeDashboard
    DeviceHealth --> SensorDashboard
    DevicePositions --> FloorPlanView
    DevicePositions --> FloorPlan3D
    DeviceHealth --> UnifiedDashboard

    %% Data to Alert System
    DataPoints --> Thresholds
    Thresholds --> AlarmCRUD
    AlarmCRUD --> AlertHistory
    AlertHistory --> AlertEscalation
    AlertEscalation --> AlertCorrelation

    %% Alert System to Notifications
    AlertEscalation --> Telegram
    AlertEscalation --> Webhook
    AlertEscalation --> SMS
    AlertEscalation --> Push
    AlertEscalation --> Email

    %% Alert to Maintenance
    AlarmCRUD --> WorkOrders
    WorkOrders --> Technicians
    WorkOrders --> Tasks
    Schedules --> WorkOrders
    PredictiveMaint --> WorkOrders

    %% Device Health to Analytics
    DeviceHealth --> MTTR_MTBF
    DeviceHealth --> HealthAnalysis
    DataPoints --> TrendAnalysis
    HealthAnalysis --> Predictions
    MTTR_MTBF --> Reports
    TrendAnalysis --> Reports

    %% Analytics to Maintenance
    Predictions --> PredictiveMaint
    MTTR_MTBF --> Schedules

    %% Firmware OTA Flow
    DeviceCRUD --> FirmwarePackages
    FirmwarePackages --> OTADeployments
    OTADeployments --> ScheduledOTA
    OTADeployments --> DeviceStatus

    %% Styling
    classDef sourceStyle fill:#0ea5e9,stroke:#0284c7,color:#fff
    classDef protocolStyle fill:#8b5cf6,stroke:#7c3aed,color:#fff
    classDef dataStyle fill:#10b981,stroke:#059669,color:#fff
    classDef deviceStyle fill:#f59e0b,stroke:#d97706,color:#fff
    classDef monitorStyle fill:#06b6d4,stroke:#0891b2,color:#fff
    classDef alertStyle fill:#ef4444,stroke:#dc2626,color:#fff
    classDef notifyStyle fill:#ec4899,stroke:#db2777,color:#fff
    classDef maintStyle fill:#84cc16,stroke:#65a30d,color:#fff
    classDef analyticsStyle fill:#6366f1,stroke:#4f46e5,color:#fff
    classDef otaStyle fill:#14b8a6,stroke:#0d9488,color:#fff

    class PLC,Sensors,Gateway,HMI,External sourceStyle
    class MQTT,OPCUA,Modbus,REST protocolStyle
    class RealtimeBuffer,DataPoints,DeviceData dataStyle
    class DeviceCRUD,DeviceGroups,DeviceTemplates,DeviceHealth,DevicePositions deviceStyle
    class RealtimeDashboard,SensorDashboard,FloorPlanView,FloorPlan3D,UnifiedDashboard monitorStyle
    class AlarmCRUD,Thresholds,AlertHistory,AlertEscalation,AlertCorrelation alertStyle
    class Telegram,Webhook,SMS,Push,Email notifyStyle
    class WorkOrders,Technicians,Tasks,Schedules,PredictiveMaint maintStyle
    class MTTR_MTBF,HealthAnalysis,TrendAnalysis,Predictions,Reports analyticsStyle
    class FirmwarePackages,OTADeployments,ScheduledOTA,DeviceStatus otaStyle
